<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<![endif]-->
<title>VIM 中文帮助: Vim 和 Vim 脚本的测试</title>
<link rel="stylesheet" href="vim-stylesheet.css" type="text/css" />
<link rel="canonical" href="https://yianwillis.github.io/vimcdoc/doc/testing.html" />
<script type="text/javascript" src="vimcdoc.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
<nav id=banner>
<form action=tags.html target="tag_iframe">
  <input type="text" name="tag" id="tag" placeholder="标签搜索">
</form>
<iframe name="tag_iframe" src=""></iframe>
<a href="help.html">帮助总览</a> &middot;
<hr/>
<a href="quickref.html">快速参考</a> &middot;
<a href="index.html">命令索引</a> &middot;
<a href="eval.html#functions">函数列表</a> &middot;
<a href="quickref.html#option-list">选项列表</a> &middot;
<hr/>
<a href="usr_toc.html">用户手册</a> &middot;
<a href="help.html#reference_toc">参考手册</a> &middot;
</nav>

<header>
<h2>testing</h2>
</header>
<article id=outer>
<section class=inner>
<b class="vimtag"> <a name="testing.txt">testing.txt</a> </b>   适用于 Vim 8.2 版本。   最近更新: 2020年2月


                  <code class="vim">VIM 参考手册    by Bram Moolenaar</code>
                                <code class="vim">译者</code>: Willis


测试 Vim 和 Vim 脚本                            <b class="vimtag"> <a name="testing-support">testing-support</a> </b>

 <a href="eval.html#eval.txt">eval.txt</a>  说明表达式的计算。此文件描述 Vim 脚本中编写测试的细节。这可用于 Vim
自身和插件的测试。

1. 测试 Vim                              <a href="testing.html#testing">testing</a> 
2. 测试函数                              <a href="testing.html#test-functions-details">test-functions-details</a> 
3. 断言函数                              <a href="testing.html#assert-functions-details">assert-functions-details</a> 

</section><hr class="doubleline" /><section class=inner>
<h4>1. 测试 Vim                                             <b class="vimtag"> <a name="testing">testing</a> </b></h4>
Vim 在编译后可以进行测试，通常用 "make test" 进行。
这些测试位于目录 "src/testdir"。

在不同的时间点，加入了几种不同类型的测试:
        test33.in               最老的，不要再加了
        test_something.in       旧风格测试
        test_something.vim      新风格测试

                                                <b class="vimtag"> <a name="new-style-testing">new-style-testing</a> </b>
新写的测试需用新风格的测试。使用  <a href="testing.html#assert_equal()">assert_equal()</a>  之类的函数，以便在同一处地方
维护测试命令和期待的结果。
                                                <b class="vimtag"> <a name="old-style-testing">old-style-testing</a> </b>
有些场合仍然需要旧风格的测试。例如在没有  <a href="various.html#+eval">+eval</a>  特性时测试 Vim。

更多信息可见文件 src/testdir/README.txt。

</section><hr class="doubleline" /><section class=inner>
<h4>2. 测试函数                                     <b class="vimtag"> <a name="test-functions-details">test-functions-details</a> </b></h4>
test_alloc_fail(<code class="special">{id}</code>, <code class="special">{countdown}</code>, <code class="special">{repeat}</code>)            <b class="vimtag"> <a name="test_alloc_fail()">test_alloc_fail()</a> </b>
                用于测试: 如果调用了 <code class="special">{id}</code> 指定的内存分配，<code class="special">{countdown}</code> 减一，到
                零时，让内存分配失败 <code class="special">{repeat}</code> 次。如果 <code class="special">{repeat}</code> 小于一，失败一
                次。

                也可用作  <a href="eval.html#method">method</a> : 
<code class="example">                        GetAllocId()-&gt;test_alloc_fail()</code>
<code class="example"></code>
test_autochdir()                                        <b class="vimtag"> <a name="test_autochdir()">test_autochdir()</a> </b>
                设置标志位，在 Vim 启动过程结束之前，打开 <a href="options.html#'autochdir'">'autochdir'</a> 的效果。


test_feedinput(<code class="special">{string}</code>)                                <b class="vimtag"> <a name="test_feedinput()">test_feedinput()</a> </b>
                <code class="special">{string}</code> 中的字符会如果是用户键入的那样，排队依次等待处理。使
                用一个低层输入缓冲区。此函数只适用于  <a href="eval.html#+unix">+unix</a>  或 GUI 运行时。

                也可用作  <a href="eval.html#method">method</a> : 
<code class="example">                        GetText()-&gt;test_feedinput()</code>
<code class="example"></code>
test_garbagecollect_now()                        <b class="vimtag"> <a name="test_garbagecollect_now()">test_garbagecollect_now()</a> </b>
                类似于 garbagecollect()，但立即执行。只能通过直接调用，以避免
                内部保存任何结构，而调用任何函数前， <a href="eval.html#v:testing">v:testing</a>  必须置位。

test_garbagecollect_soon()                       <b class="vimtag"> <a name="test_garbagecollect_soon()">test_garbagecollect_soon()</a> </b>
                就像在 main 循环中那样，设置标志位来调用垃圾清理器。仅用于测
                试。


test_getvalue(<code class="special">{name}</code>)                                   <b class="vimtag"> <a name="test_getvalue()">test_getvalue()</a> </b>
                取得内部变量的值。支持以下的 <code class="special">{name}</code> 值:
                        need_fileinfo

                也可用作  <a href="eval.html#method">method</a> : 
<code class="example">                        GetName()-&gt;test_getvalue()</code>
<code class="example"></code>
test_ignore_error(<code class="special">{expr}</code>)                        <b class="vimtag"> <a name="test_ignore_error()">test_ignore_error()</a> </b>
                忽略包含 <code class="special">{expr}</code> 的任何错误。显示正常的消息来替代。
                只用于测试，因为那里 try/catch 不能用于捕捉错误 (因为跳过了下
                面的代码)。
                <code class="special">{expr}</code> 按本义使用，不用作模式。
                如果 <code class="special">{expr}</code> 为字符串 "RESET"，清空忽略错误的列表。

                也可用作  <a href="eval.html#method">method</a> : 
<code class="example">                        GetErrorText()-&gt;test_ignore_error()</code>
<code class="example"></code>
test_null_blob()                                        <b class="vimtag"> <a name="test_null_blob()">test_null_blob()</a> </b>
                返回 null  <a href="eval.html#Blob">Blob</a> 。仅用于测试。


test_null_channel()                                     <b class="vimtag"> <a name="test_null_channel()">test_null_channel()</a> </b>
                返回 null  <a href="eval.html#Channel">Channel</a> 。仅用于测试。
                <code class="notvi">{仅当编译时加入  <a href="various.html#+channel">+channel</a>  特性才有效}</code>

test_null_dict()                                        <b class="vimtag"> <a name="test_null_dict()">test_null_dict()</a> </b>
                返回 null  <a href="eval.html#Dict">Dict</a> 。仅用于测试。

test_null_job()                                         <b class="vimtag"> <a name="test_null_job()">test_null_job()</a> </b>
                返回 null  <a href="eval.html#Job">Job</a> 。仅用于测试。
                <code class="notvi">{仅当编译时加入  <a href="various.html#+job">+job</a>  特性才有效}</code>

test_null_list()                                        <b class="vimtag"> <a name="test_null_list()">test_null_list()</a> </b>
                返回 null  <a href="eval.html#List">List</a> 。仅用于测试。

test_null_partial()                                     <b class="vimtag"> <a name="test_null_partial()">test_null_partial()</a> </b>
                返回 null  <a href="eval.html#Partial">Partial</a> 。仅用于测试。

test_null_string()                                      <b class="vimtag"> <a name="test_null_string()">test_null_string()</a> </b>
                返回 null  <a href="eval.html#String">String</a> 。仅用于测试。

test_option_not_set(<code class="special">{name}</code>)                             <b class="vimtag"> <a name="test_option_not_set()">test_option_not_set()</a> </b>
                复位指示选项 <code class="special">{name}</code> 已设置过的标志位。就像看起来此选项还使用缺
                省值那样。这样来用: 
<code class="example">                        set ambiwidth=double</code>
<code class="example">                        call test_option_not_set('ambiwidth')</code>
                现在 <a href="options.html#'ambiwidth'">'ambiwidth'</a> 选项的行为就像它从未被改变过一样，即使它的值
                是 "double"。
                仅用于测试！

                也可用作  <a href="eval.html#method">method</a> : 
<code class="example">                        GetOptionName()-&gt;test_option_not_set()</code>
<code class="example"></code>
<code class="example"></code>
test_override(<code class="special">{name}</code>, <code class="special">{val}</code>)                            <b class="vimtag"> <a name="test_override()">test_override()</a> </b>
                覆盖 Vim 内部处理的部分行为，用于运行测试。只能用于 Vim 测试！
                如果 <code class="special">{val}</code> 非零，打开覆盖行为，<code class="special">{val}</code> 为零时，关闭覆盖行为。
                目前支持的名字是:

<code class="section">                名字         <code class="special">{val}</code> 非零的效果 </code>
                redraw       屏蔽 redrawing() 函数
                redraw_flag  忽略 RedrawingDisabled 标志位
                char_avail   屏蔽 char_avail() 函数
                starting     复位 "starting" 变量，见下
                nfa_fail     使 NFA 正规表达式引擎失败以强制回归到旧引擎
                no_query_mouse  "dec" 终端不查询鼠标位置
                no_wait_return  置位 "no_wait_return" 标志位。不被 "ALL" 复
                                位。
                ALL          复位所有覆盖 (不使用 <code class="special">{val}</code>)

                "starting" 用于假定初始化已经完成的测试。因为测试的运行是通过
                运行一个 "starting" 变量为非零的脚本进行的。这通常有好处 (测试
                更快)，但有时会改变行为，使测试不能正常工作。
                以下操作: 
<code class="example">                        call test_override('starting', 1)</code>
                保存 "starting" 的值。以下操作恢复之: 
<code class="example">                        call test_override('starting', 0)</code>
<code class="example"></code>
                也可用作  <a href="eval.html#method">method</a> : 
<code class="example">                        GetOverrideVal()-&gt; test_override('starting')</code>
<code class="example"></code>
test_refcount(<code class="special">{expr}</code>)                                   <b class="vimtag"> <a name="test_refcount()">test_refcount()</a> </b>
                返回 <code class="special">{expr}</code> 的引用计数。如果 <code class="special">{expr}</code> 是没有引用计数的类型，返回
                -1。仅用于测试。

                也可用作  <a href="eval.html#method">method</a> : 
<code class="example">                        GetVarname()-&gt;test_refcount()</code>
<code class="example"></code>
<code class="example"></code>
test_scrollbar(<code class="special">{which}</code>, <code class="special">{value}</code>, <code class="special">{dragging}</code>)            <b class="vimtag"> <a name="test_scrollbar()">test_scrollbar()</a> </b>
                模拟使用滚动条 <code class="special">{which}</code> 移动到位置 <code class="special">{value}</code>。<code class="special">{which}</code> 可以是:
                        left    当前窗口的左侧滚动条
                        right   当前窗口的右侧滚动条
                        hor     水平滚动条

                对垂直滚动条而言，<code class="special">{value}</code> 可取值 1 到缓冲区行数。对水平滚动条
                而言，<code class="special">{value}</code> 可取值 1 到最大的行长，假定 <a href="options.html#'wrap'">'wrap'</a> 未置位。

                <code class="special">{dragging}</code> 如果非零，行为就像拖动滚动条，否则像点击滚动条。
                只能用于确实存在的 <code class="special">{which}</code> 滚动条，显然只能用于 GUI。

                也可用作  <a href="eval.html#method">method</a> : 
<code class="example">                        GetValue()-&gt;test_scrollbar('right', 0)</code>
<code class="example"></code>
test_setmouse(<code class="special">{row}</code>, <code class="special">{col}</code>)                             <b class="vimtag"> <a name="test_setmouse()">test_setmouse()</a> </b>
                设置下个鼠标活动所用的鼠标位置。
                <code class="special">{row}</code> 和 <code class="special">{col}</code> 从 1 开始。
                示例: 
<code class="example">                        call test_setmouse(4, 20)</code>
<code class="example">                        call feedkeys("\&lt;LeftMouse&gt;", "xt")</code>
<code class="example"></code>
test_settime(<code class="special">{expr}</code>)                                    <b class="vimtag"> <a name="test_settime()">test_settime()</a> </b>
                设置 Vim 内部使用的时间。目前只用于历史中的时间戳，用于
                viminfo 和撤销。
                值为 1 使 Vim 在<code class="note">警告</code>或信息后不睡眠。
                <code class="special">{expr}</code> 计算结果必须为数值。值为零时恢复正常行为。

                也可用作  <a href="eval.html#method">method</a> : 
<code class="example">                        GetTime()-&gt;test_settime()</code>
<code class="example"></code>
test_srand_seed([seed])                                 <b class="vimtag"> <a name="test_srand_seed()">test_srand_seed()</a> </b>
                <code class="special">[seed]</code> 给出时用来设置  <a href="eval.html#srand()">srand()</a>  使用的种子值。不给出时，删除此
                测试用种子。

</section><hr class="doubleline" /><section class=inner>
<h4>3. 断言函数                                     <b class="vimtag"> <a name="assert-functions-details">assert-functions-details</a> </b></h4>

assert_beeps(<code class="special">{cmd}</code>)                                     <b class="vimtag"> <a name="assert_beeps()">assert_beeps()</a> </b>
                执行 <code class="special">{cmd}</code>，如果 <code class="emphasis">不</code> 响铃或可视响铃，加入错误信息到
                 <a href="eval.html#v:errors">v:errors</a> 。
                另见  <a href="testing.html#assert_fails()">assert_fails()</a>  和  <a href="eval.html#assert-return">assert-return</a> 。

                也可用作  <a href="eval.html#method">method</a> : 
<code class="example">                        GetCmd()-&gt;assert_beeps()</code>

                                                        <b class="vimtag"> <a name="assert_equal()">assert_equal()</a> </b>
assert_equal(<code class="special">{expected}</code>, <code class="special">{actual}</code> [, <code class="special">{msg}</code>])
                <code class="special">{expected}</code> 不等于 <code class="special">{actual}</code> 时，加入错误信息到  <a href="eval.html#v:errors">v:errors</a> ，并反
                回 1。否则返回零  <a href="eval.html#assert-return">assert-return</a> 。
                没有自动转换，字符串 "4" 不同于数值 4。数值 4 又不同于浮点数
                4.0。不适用 <a href="options.html#'ignorecase'">'ignorecase'</a>，大小写永远敏感。
                省略 <code class="special">{msg}</code> 则生成形如 "Expected <code class="special">{expected}</code> but got <code class="special">{actual}</code>"
                的错误。
                示例: 
<code class="example">        assert_equal('foo', 'bar')</code>
                会在  <a href="eval.html#v:errors">v:errors</a>  加入字符串:
<code class="section">        test.vim line 12: Expected <code class="badlink">'foo'</code> but got <code class="badlink">'bar'</code> </code>

                也可用作  <a href="eval.html#method">method</a> : 
<code class="example">                        mylist-&gt;assert_equal([1, 2, 3])</code>
<code class="example"></code>
<code class="example"></code>
                                                        <b class="vimtag"> <a name="assert_equalfile()">assert_equalfile()</a> </b>
assert_equalfile(<code class="special">{fname-one}</code>, <code class="special">{fname-two}</code>)
                文件 <code class="special">{fname-one}</code> 和 <code class="special">{fname-two}</code> 不包含相同文本时，加入错误信息
                到  <a href="eval.html#v:errors">v:errors</a> 。
                另见  <a href="eval.html#assert-return">assert-return</a> 。
                文件 <code class="special">{fname-one}</code> 或 <code class="special">{fname-two}</code> 不存在时，错误信息说明这一点。
                最常用于  <a href="terminal.html#terminal-diff">terminal-diff</a> 。

                也可用作  <a href="eval.html#method">method</a> : 
<code class="example">                        GetLog()-&gt;assert_equalfile('expected.log')</code>
<code class="example"></code>
<code class="example"></code>
assert_exception(<code class="special">{error}</code> [, <code class="special">{msg}</code>])                     <b class="vimtag"> <a name="assert_exception()">assert_exception()</a> </b>
                v:exception 不包含 <code class="special">{error}</code> 时，加入错误信息到  <a href="eval.html#v:errors">v:errors</a> 。另见
                 <a href="eval.html#assert-return">assert-return</a> 。
                可用于断言命令抛出例外。使用错误号后加冒号，就不用担心翻译的问
                题: 
<code class="example">                        try</code>
<code class="example">                          commandthatfails</code>
<code class="example">                          call assert_false(1, 'command should have failed')</code>
<code class="example">                        catch</code>
<code class="example">                          call assert_exception('E492:')</code>
<code class="example">                        endtry</code>
<code class="example"></code>
assert_fails(<code class="special">{cmd}</code> [, <code class="special">{error}</code> [, <code class="special">{msg}</code>]])                       <b class="vimtag"> <a name="assert_fails()">assert_fails()</a> </b>
                执行 <code class="special">{cmd}</code>，如果 <code class="emphasis">不</code> 出错，加入错误信息到  <a href="eval.html#v:errors">v:errors</a> 。另见
                 <a href="eval.html#assert-return">assert-return</a> 。
                给出 <code class="special">{error}</code> 时，必须匹配  <a href="eval.html#v:errmsg">v:errmsg</a> 。
                <code class="note">注意</code> 响铃不作为错误处理，而有些出错的命令只会响铃。为此，可用
                 <a href="testing.html#assert_beeps()">assert_beeps()</a>  断言。

                也可用作  <a href="eval.html#method">method</a> : 
<code class="example">                        GetCmd()-&gt;assert_fails('E99:')</code>
<code class="example"></code>
assert_false(<code class="special">{actual}</code> [, <code class="special">{msg}</code>])                                <b class="vimtag"> <a name="assert_false()">assert_false()</a> </b>
                <code class="special">{actual}</code> 不为假时，加入错误信息到  <a href="eval.html#v:errors">v:errors</a> ，其余类同
                 <a href="testing.html#assert_equal()">assert_equal()</a> 。
                另见  <a href="eval.html#assert-return">assert-return</a> 。
                零值为假值。<code class="special">{actual}</code> 不是数值时，断言失败。
                省略 <code class="special">{msg}</code> 则生成形如 "Expected False but got <code class="special">{actual}</code>" 的错
                误。

                也可用作  <a href="eval.html#method">method</a> : 
<code class="example">                        GetResult()-&gt;assert_false()</code>
<code class="example"></code>
assert_inrange(<code class="special">{lower}</code>, <code class="special">{upper}</code>, <code class="special">{actual}</code> [, <code class="special">{msg}</code>])     <b class="vimtag"> <a name="assert_inrange()">assert_inrange()</a> </b>
                对数值和  <a href="eval.html#Float">Float</a>  值进行断言。<code class="special">{actual}</code> 小于 <code class="special">{lower}</code> 会大于
                <code class="special">{upper}</code> 时，加入错误信息到  <a href="eval.html#v:errors">v:errors</a> 。另见  <a href="eval.html#assert-return">assert-return</a> 。
                省略 <code class="special">{msg}</code> 则生成形如 "Expected range <code class="special">{lower}</code> - <code class="special">{upper}</code>, but
                got <code class="special">{actual}</code>" 的错误。

                                                                <b class="vimtag"> <a name="assert_match()">assert_match()</a> </b>
assert_match(<code class="special">{pattern}</code>, <code class="special">{actual}</code> [, <code class="special">{msg}</code>])
                <code class="special">{pattern}</code> 不匹配 <code class="special">{actual}</code> 时，加入错误信息到  <a href="eval.html#v:errors">v:errors</a> 。另见
                 <a href="eval.html#assert-return">assert-return</a> 。

                <code class="special">{pattern}</code> 的用法类同于  <code class="badlink">=~</code> : 匹配总是假定 <a href="options.html#'magic'">'magic'</a> 置位而
                <a href="options.html#'cpoptions'">'cpoptions'</a> 为空，而忽略 <a href="options.html#'magic'">'magic'</a> 或 <a href="options.html#'cpoptions'">'cpoptions'</a> 的实际值。

                <code class="special">{actual}</code> 作字符串使用，适用自动转换。
                "^" 和 "$" 可用来匹配文本的开始和结尾。两者皆用则可匹配整个文
                本。

                省略 <code class="special">{msg}</code> 则生成形如 "Pattern <code class="special">{pattern}</code> does not match
                <code class="special">{actual}</code>" 的错误。
                示例: 
<code class="example">        assert_match('^f.*o$', 'foobar')</code>
                会在  <a href="eval.html#v:errors">v:errors</a>  加入字符串:
<code class="section">        test.vim line 12: Pattern '^f.*o$' does not match <code class="badlink">'foobar'</code> </code>

                也可用作  <a href="eval.html#method">method</a> : 
<code class="example">                        getFile()-&gt;assert_match('foo.*')</code>

                                                        <b class="vimtag"> <a name="assert_notequal()">assert_notequal()</a> </b>
assert_notequal(<code class="special">{expected}</code>, <code class="special">{actual}</code> [, <code class="special">{msg}</code>])
                和  <a href="testing.html#assert_equal()">assert_equal()</a>  相反: <code class="special">{expected}</code> 等于 <code class="special">{actual}</code> 时，加入错
                误信息到  <a href="eval.html#v:errors">v:errors</a> 。
                另见  <a href="eval.html#assert-return">assert-return</a> 。

                也可用作  <a href="eval.html#method">method</a> : 
<code class="example">                        mylist-&gt;assert_notequal([1, 2, 3])</code>
<code class="example"></code>
                                                        <b class="vimtag"> <a name="assert_notmatch()">assert_notmatch()</a> </b>
assert_notmatch(<code class="special">{pattern}</code>, <code class="special">{actual}</code> [, <code class="special">{msg}</code>])
                和  <a href="testing.html#assert_match()">assert_match()</a>  相反: <code class="special">{pattern}</code> 匹配 <code class="special">{actual}</code> 时，加入错
                误信息到  <a href="eval.html#v:errors">v:errors</a> 。
                另见  <a href="eval.html#assert-return">assert-return</a> 。

                也可用作  <a href="eval.html#method">method</a> : 
<code class="example">                        getFile()-&gt;assert_notmatch('bar.*')</code>
<code class="example"></code>
<code class="example"></code>
assert_report(<code class="special">{msg}</code>)                                    <b class="vimtag"> <a name="assert_report()">assert_report()</a> </b>
                直接报告测试失败，用 <code class="special">{msg}</code>。总返回一。

                也可用作  <a href="eval.html#method">method</a> : 
<code class="example">                        GetMessage()-&gt;assert_report()</code>
<code class="example"></code>
<code class="example"></code>
assert_true(<code class="special">{actual}</code> [, <code class="special">{msg}</code>])                         <b class="vimtag"> <a name="assert_true()">assert_true()</a> </b>
                <code class="special">{actual}</code> 不为真时，加入错误信息到  <a href="eval.html#v:errors">v:errors</a> ，余类同
                 <a href="testing.html#assert_equal()">assert_equal()</a> 。
                另见  <a href="eval.html#assert-return">assert-return</a> 。
                非零值为真值。<code class="special">{actual}</code> 不是数值时，断言失败。
                省略 <code class="special">{msg}</code> 则生成形如 "Expected True but got <code class="special">{actual}</code>" 的错
                误。

                也可用作  <a href="eval.html#method">method</a> : 
<code class="example">                        GetResult()-&gt;assert_true()</code>
<code class="example"></code>

 vim:tw=78:ts=8:noet:ft=help:norl:
</section>
</article>
<footer>
Generated by vim2html
</footer>
</body>
</html>
